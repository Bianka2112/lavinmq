<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Queue | AvalancheMQ</title>
    <link href="/main.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <meta name="google" content="notranslate">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body>
    <header></header>
    <aside></aside>
    <main>
      <h2>
        Queue:
        <small id="queue"></small>
      </h2>
      <table class="details-table">
        <tr>
          <th>Features</th>
          <td id="q-features"></td>
          <th>State</th>
          <td id="q-state"></td>
          <th rowspan="2">Messages</th>
          <td rowspan="2">
            <table>
              <tr>
                <th>Total</th>
                <th>Ready</th>
                <th>Unacked</th>
              </tr>
              <tr>
                <td id="q-total"></td>
                <td id="q-ready"></td>
                <td id="q-unacked"></td>
              </tr>
            </table>
          </td>
        </tr>
        <tr>
          <th>Policy</th>
          <td id="q-policy"></td>
          <th>Consumers</th>
          <td id="q-consumers"></td>
        </tr>
      </table>
      <div id="table-error"></div>
      <h3>
        Consumers
        <small id="table-count"></small>
      </h3>
      <table id="table" class="table">
        <thead>
          <tr>
            <th>Channel</th>
            <th>Consumer tag</th>
            <th>Ack required</th>
            <th>Exclusive</th>
            <th>Prefetch count</th>
            <th>Arguments</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="bindings-table-error"></div>
      <h3>
        Bindings
        <small id="bindings-table-count"></small>
      </h3>
      <table id="bindings-table" class="table">
        <thead>
          <tr>
            <th>From</th>
            <th>Routing key</th>
            <th>Arguments</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <form method="post" id="addBinding" class="form">
        <fieldset>
          <legend>Add a binding to this queue</legend>
          <label>
            <span>From exchange</span>
            <input name="source" type="text" required>
          </label>
          <label>
            <span>Routing key</span>
            <input name="routing_key" type="text">
          </label>
          <label>
            <span>Arguments</span>
            <textarea name="arguments" placeholder='{ "key": value }'></textarea>
          </label>
          <button type="submit">Bind</button>
        </fieldset>
      </form>
      <form method="post" id="publishMessage" class="form">
        <fieldset>
          <legend>Publish message</legend>
          <p>
            Message will be published to the default exchange with routing key <span class="queue"></span>, routing it to this queue.
          </p>
          <label>
            <span>Delivery mode</span>
            <select name="delivery_mode">
              <option value="1">1 - Transient</option>
              <option value="2">2 - Persistent</option>
            </select>
          </label>
          <label>
            <span>Headers</span>
            <textarea name="headers" placeholder='{ "key": value }'></textarea>
          </label>
          <label>
            <span>Properties</span>
            <textarea name="properties" placeholder='{ "key": value }'></textarea>
          </label>
          <label>
            <span>Payload</span>
            <textarea name="payload"></textarea>
          </label>
          <button type="submit">Publish message</button>
        </fieldset>
      </form>
      <form method="post" id="getMessages" class="form">
        <fieldset>
          <legend>Get messages</legend>
          <label>
            <span>Mode</span>
            <select name="mode">
              <option value="peek">Peek</option>
              <option value="ack_requeue_true">Ack and requeue</option>
              <option value="ack_requeue_false">Ack</option>
              <option value="reject_requeue_true">Reject and requeue</option>
              <option value="reject_requeue_false">Reject</option>

            </select>
          </label>
          <label>
            <span>Encoding</span>
            <select name="encoding">
              <option value="auto">Auto string/base64</option>
              <option value="base64">Base64</option>
            </select>
          </label>
          <label>
            <span>Messages</span>
            <input type="number" name="messages" value=1>
          </label>
          <button type="submit">Get message(s)</button>
        </fieldset>
      </form>
      <div id="message-template" class="hide">
        <span>Message <span class="message-number"></span></span>
        <hr>
        <span>The server reported <span class="messages-remaining"></span> messages remaining.</span>
        <table>
          <tr>
            <th>Exchange</th>
            <td class="message-exchange"></td>
          </tr>
          <tr>
            <th>Routing key</th>
            <td class="message-routing-key"></td>
          </tr>
          <tr>
            <th>Mode</th>
            <td class="message-mode"></td>
          </tr>
          <tr>
            <th>Properties</th>
            <td><pre class="message-properties"></pre></td>
          </tr>
          <tr>
            <th>
              Payload
              <div><small><span class="message-size"></span> bytes</small></div>
              <div><small>Encoding: <span class="message-encoding"></span></small></div>
            </th>
            <td class="message-payload"></td>
          </tr>
        </table>
      </div>
      <div id="messages"></div>
      <form method="post" id="moveMessages" class="form">
        <fieldset>
          <legend>Move messages</legend>
          <label>
            <span>Destination queue</span>
            <input type="text" name="shovel-destination">
            <button type="submit">Move messages</button>
          </label>
        </fieldset>
      </form>
      <form method="delete" id="purgeQueue" class="form">
        <fieldset>
          <legend>Purge queue</legend>
          <button type="submit">Purge</button>
        </fieldset>
      </form>
      <form method="delete" id="deleteQueue" class="form">
        <fieldset>
          <legend>Delete queue</legend>
          <button type="submit">Delete</button>
        </fieldset>
      </form>
    </main>
    <footer></footer>
    <script src="/js/layout.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/dom.js"></script>
    <script src="/js/http.js"></script>
    <script src="/js/overview.js"></script>
    <script src="/js/table.js"></script>
    <script>
      const queue = new URLSearchParams(window.location.search).get('name')
      const vhost = new URLSearchParams(window.location.search).get('vhost')
      const urlEncodedQueue = encodeURIComponent(queue)
      const urlEncodedVhost = encodeURIComponent(vhost)
      document.title = queue + ' | AvalancheMQ'

      const consumersTable = avalanchemq.table.renderTable('table', { sortBy: ['name'] }, function (tr, item) {
        const channelLink = document.createElement('a')
        channelLink.href = '/channel?name=' + encodeURIComponent(item.channel_details.name)
        channelLink.textContent = item.channel_details.name
        const ack = item.ack_required ? '●' : '○'
        const exclusive = item.exclusive ? '●' : '○'
        avalanchemq.table.renderCell(tr, 0, channelLink)
        avalanchemq.table.renderCell(tr, 1, item.consumer_tag)
        avalanchemq.table.renderCell(tr, 2, ack)
        avalanchemq.table.renderCell(tr, 3, exclusive)
        avalanchemq.table.renderCell(tr, 4, item.prefetch_count)
        avalanchemq.table.renderHtmlCell(tr, 5, '<pre>' + item.arguments + '</pre>')
      })

      const queueUrl = '/api/queues/' + urlEncodedVhost + '/' + urlEncodedQueue
      function updateQueue (all) {
        avalanchemq.http.request('GET', queueUrl).then(item => {
          document.getElementById('q-state').textContent = item.state
          document.getElementById('q-unacked').textContent = item.unacked
          document.getElementById('q-total').textContent = item.messages
          document.getElementById('q-ready').textContent = item.ready
          document.getElementById('q-consumers').textContent = item.consumers
          consumersTable.updateTable(item.consumer_details)
          if (all) {
            let features = ''
            features += item.durable ? ' D' : ''
            features += item.auto_delete ? ' AD' : ''
            features += item.exclusive ? ' E' : ''
            document.getElementById('q-features').textContent = features
            document.querySelector('#queue').textContent = queue + ' in virtual host ' + item.vhost
            document.querySelector('.queue').textContent = queue
            if (item.policy) {
              const policyLink = document.createElement('a')
              policyLink.href = '/policy?name=' + encodeURIComponent(item.policy)
              policyLink.textContent = item.policy
              avalanchemq.dom.setChild('#q-policy', policyLink)
            }
          }
        }).catch(e => console.error(e))
      }
      updateQueue(true)
      setInterval(updateQueue, 5000)

      const tableOptions = { url: queueUrl + '/bindings', sortBy: [], interval: 5000 }
      const bindingsTable = avalanchemq.table.renderTable('bindings-table', tableOptions, function (tr, item) {
        if (item.source === '') {
          const td = avalanchemq.table.renderCell(tr, 0, '(Default exchange binding)')
          td.setAttribute('colspan', 4)
        } else {
          const btn = document.createElement('button')
          btn.innerHTML = 'Unbind'
          btn.onclick = function () {
            const e = encodeURIComponent(item.source)
            const p = encodeURIComponent(item.properties_key)
            const url = '/api/bindings/' + urlEncodedVhost + '/e/' + e + '/q/' + urlEncodedQueue + '/' + p
            avalanchemq.http.request('DELETE', url)
              .then(() => console.log('binding removed'))
              .catch(e => console.error(e))
          }
          avalanchemq.table.renderCell(tr, 0, item.source)
          avalanchemq.table.renderCell(tr, 1, item.routing_key)
          avalanchemq.table.renderHtmlCell(tr, 2, '<pre>' + JSON.stringify(item.arguments) + '</pre>')
          avalanchemq.table.renderCell(tr, 3, btn)
        }
      })

      document.querySelector('#addBinding').addEventListener('submit', function (evt) {
        evt.preventDefault()
        const data = new FormData(this)
        const e = encodeURIComponent(data.get('source'))
        const url = '/api/bindings/' + urlEncodedVhost + '/e/' + e + '/q/' + urlEncodedQueue
        const args = avalanchemq.dom.parseJSON(data.get('arguments'))
        const body = {
          routing_key: data.get('routing_key'),
          arguments: args
        }
        avalanchemq.http.request('POST', url, { body })
          .then(() => {
            bindingsTable.fetchAndUpdate()
          }).catch(e => console.error(e))
      })

      document.querySelector('#publishMessage').addEventListener('submit', function (evt) {
        evt.preventDefault()
        const data = new FormData(this)
        const url = '/api/exchanges/' + urlEncodedVhost + '/amq.default/publish'
        const properties = avalanchemq.dom.parseJSON(data.get('properties'))
        properties.delivery_mode = parseInt(data.get('delivery_mode'))
        properties.headers = avalanchemq.dom.parseJSON(data.get('headers'))
        const body = {
          payload: data.get('payload'),
          payload_encoding: 'string',
          routing_key: queue,
          properties
        }
        avalanchemq.http.request('POST', url, { body })
          .then(() => {
            updateQueue(false)
          }).catch(e => console.error(e))
      })

      document.querySelector('#getMessages').addEventListener('submit', function (evt) {
        evt.preventDefault()
        const data = new FormData(this)
        const url = '/api/queues/' + urlEncodedVhost + '/' + urlEncodedQueue + '/get'
        const body = {
          count: parseInt(data.get('messages')),
          ack_mode: data.get('mode'),
          encoding: data.get('encoding'),
          truncate: 50000
        }
        avalanchemq.http.request('POST', url, { body })
          .then(messages => {
            updateQueue(false)
            const messagesContainer = document.getElementById('messages')
            avalanchemq.dom.removeChildren(messagesContainer)
            const template = document.getElementById('message-template')
            for (let i = 0; i < messages.length; i++) {
              const message = messages[i]
              const msgNode = template.cloneNode(true)
              msgNode.querySelector('.message-number').textContent = i + 1
              msgNode.querySelector('.messages-remaining').textContent = message.message_count
              const exchange = message.exchange === '' ? '(AMQP default)' : message.exchange;
              msgNode.querySelector('.message-exchange').textContent = exchange
              msgNode.querySelector('.message-routing-key').textContent = message.routing_key
              const mode = message.peek ? 'peek' : (message.redelivered ? 'redelivered' : 'get');
              msgNode.querySelector('.message-mode').textContent = mode
              msgNode.querySelector('.message-properties').textContent = avalanchemq.dom.jsonToText(message.properties)
              msgNode.querySelector('.message-size').textContent = message.payload_bytes
              msgNode.querySelector('.message-encoding').textContent = message.payload_encoding
              msgNode.querySelector('.message-payload').textContent = JSON.stringify(message.payload)
              msgNode.classList.remove('hide')
              messagesContainer.appendChild(msgNode)
            }
          }).catch(e => console.error(e))
      })

      document.querySelector('#moveMessages').addEventListener('submit', function (evt) {
        evt.preventDefault()
        const shovel = 'Move from ' + queue
        const url = '/api/parameters/shovel/' + urlEncodedVhost + '/' + encodeURIComponent(shovel)
        const body = {
          name: shovel,
          value: {
            'src-uri': 'amqp:///' + urlEncodedVhost,
            'src-queue': queue,
            'dest-uri': 'amqp:///' + urlEncodedVhost,
            'dest-queue': document.querySelector('[name=shovel-destination]').value,
            'prefetch': 1000,
            'ack-mode': 'on-confirm',
            'add-forward-headers': false,
            'delete-after': 'queue-length'
          }
        }
        avalanchemq.http.request('PUT', url, { body })
          .then(() => { window.location == '/queues' })
          .catch(e => console.error(e))
      })

      document.querySelector('#purgeQueue').addEventListener('submit', function (evt) {
        evt.preventDefault()
        const url = '/api/queues/' + urlEncodedVhost + '/' + urlEncodedQueue + '/contents'
        avalanchemq.http.request('DELETE', url)
          .catch(e => console.error(e))
      })

      document.querySelector('#deleteQueue').addEventListener('submit', function (evt) {
        evt.preventDefault()
        const url = '/api/queues/' + urlEncodedVhost + '/' + urlEncodedQueue
        avalanchemq.http.request('DELETE', url)
          .then(() => { window.location = '/queues' })
          .catch(e => console.error(e))
      })
    </script>
  </body>
</html>
