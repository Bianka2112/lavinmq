<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Exchange | AvalancheMQ</title>
    <link href="/main.css" rel="stylesheet">
    <meta name="google" content="notranslate">
  </head>
  <body>
    <div class="container">
      <header>
        <h1>
          AvalancheMQ
          <small id="version"></small>
        </h1>
        <div id="user-info">
          <span>ðŸ‘¤:&nbsp;</span>
          <span id="username"></span>
          <span id="vhost"></span>
        </div>
      </header>
      <ul id="menu">
        <li><a href="/">Overview</a></li>
        <li><a href="/connections">Connections</a></li>
        <li><a href="/channels">Channels</a></li>
        <li><a href="/queues">Queues</a></li>
        <li><a href="/exchanges">Exchanges</a></li>
        <li><a href="/users">Users</a></li>
        <li><a href="/vhosts">Virtual Hosts</a></li>
      </ul>
      <h2>
        Exchange:
        <small id="exchange"></small>
      </h2>
      <table>
        <tr>
          <th>Type</th>
          <td id="e-type"></td>
        </tr>
        <tr>
          <th>Features</th>
          <td id="e-features"></td>
        </tr>
        <tr>
          <th>Policy</th>
          <td id="e-policy"></td>
        </tr>
      </table>
      <div id="bindings-table-error"></div>
      <h3>
        Bindings
        <small id="bindings-table-count"></small>
      </h3>
      <table id="bindings-table" class="table">
        <thead>
          <tr>
            <th>Type</th>
            <th>To</th>
            <th>Routing key</th>
            <th>Arguments</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <form method="post" id="addBinding">
        <fieldset>
          <legend>Add a binding from this exchange</legend>
          <label>
            <select name="dest-type" required>
              <option value="q">To queue</option>
              <option value="e">To exchange</option>
            </select>
            <input name="destination" type="text" required>
          </label>
          <label>
            Routing key
            <input name="routing_key" type="text">
          </label>
          <label>
            Arguments
            <textarea name="arguments" placeholder='{ "key": value }'></textarea>
          </label>
          <button type="submit">Bind</button>
        </fieldset>
      </form>
      <form method="post" id="publishMessage">
        <fieldset>
          <legend>Publish message</legend>
          <label>
            Routing key
            <input name="routing_key" type="text">
          </label>
          <label>
            Delivery mode
            <select name="delivery_mode">
              <option value="1">1 - Transient</option>
              <option value="2">2 - Persistent</option>
            </select>
          </label>
          <label>
            Headers
            <textarea name="headers" placeholder='{ "key": value }'></textarea>
          </label>
          <label>
            Properties
            <textarea name="properties" placeholder='{ "key": value }'></textarea>
          </label>
          <label>
            Payload
            <textarea name="payload"></textarea>
          </label>
          <button type="submit">Publish message</button>
        </fieldset>
      </form>
      <form method="delete" id="deleteExchange">
        <fieldset>
          <legend>Delete exchange</legend>
          <button type="submit">Delete</button>
        </fieldset>
      </form>
    </div>
    <script src="/js/auth.js"></script>
    <script src="/js/dom.js"></script>
    <script src="/js/http.js"></script>
    <script src="/js/overview.js"></script>
    <script src="/js/table.js"></script>
    <script>
      const exchange = new URLSearchParams(window.location.search).get('name')
      const vhost = new URLSearchParams(window.location.search).get('vhost')
      const urlEncodedExchange = encodeURIComponent(exchange)
      const urlEncodedVhost = encodeURIComponent(vhost)
      document.title = exchange + ' | AvalancheMQ'

      const exchangeUrl = '/api/exchanges/' + urlEncodedVhost + '/' + urlEncodedExchange
      function updateExchange () {
        avalanchemq.http.request('GET', exchangeUrl).then(item => {
          let features = ''
          features += item.durable ? ' D' : ''
          features += item.auto_delete ? ' AD' : ''
          features += item.internal ? ' I' : ''
          document.getElementById('e-features').textContent = features
          document.getElementById('e-type').textContent = item.type
          document.querySelector('#exchange').textContent = exchange + ' in virtual host ' + item.vhost
          if (item.policy) {
            const policyLink = document.createElement('a')
            policyLink.href = '/policy?name=' + encodeURIComponent(item.policy)
            policyLink.textContent = item.policy
            avalanchemq.dom.setChild('#e-policy', policyLink)
          }
        }).catch(e => console.error(e))
      }
      updateExchange()

      const tableOptions = { url: exchangeUrl + '/bindings/destination', sortBy: [], interval: 5000 }
      avalanchemq.table.renderTable('bindings-table', tableOptions, function (tr, item) {
        if (item.source === '') {
          const td = avalanchemq.table.renderCell(tr, 0, '(Default exchange binding)')
          td.setAttribute('colspan', 5)
        } else {
          const btn = document.createElement('button')
          btn.innerHTML = 'Unbind'
          btn.onclick = function () {
            const e = encodeURIComponent(item.source)
            const p = encodeURIComponent(item.properties_key)
            const url = '/api/bindings/' + urlEncodedVhost + '/e/' + e + '/e/' + urlEncodedExchange + '/' + p
            avalanchemq.http.request('DELETE', url)
              .then(() => console.log('binding removed'))
              .catch(e => console.error(e))
          }
          avalanchemq.table.renderCell(tr, 0, item.destination_type)
          avalanchemq.table.renderCell(tr, 1, item.source)
          avalanchemq.table.renderCell(tr, 2, item.routing_key)
          avalanchemq.table.renderHtmlCell(tr, 3, '<pre>' + JSON.stringify(item.arguments) + '</pre>')
          avalanchemq.table.renderCell(tr, 4, btn)
        }
      })

      document.querySelector('#addBinding').addEventListener('submit', function (evt) {
        evt.preventDefault()
        const data = new FormData(this)
        const d = encodeURIComponent(data.get('destination'))
        const t = data.get('dest-type')
        const url = '/api/bindings/' + urlEncodedVhost + '/e/' + urlEncodedExchange + '/' + t + '/' + d
        const args = avalanchemq.dom.parseJSON(data.get('arguments'))
        const body = {
          routing_key: data.get('routing_key'),
          arguments: args
        }
        avalanchemq.http.request('POST', url, { body })
          .then(() => console.log('binding added'))
          .catch(e => console.error(e))
      })

      document.querySelector('#publishMessage').addEventListener('submit', function (evt) {
        evt.preventDefault()
        const data = new FormData(this)
        const url = '/api/exchanges/' + urlEncodedVhost + '/' + urlEncodedExchange + '/publish'
        const properties = avalanchemq.dom.parseJSON(data.get('properties'))
        properties.delivery_mode = parseInt(data.get('delivery_mode'))
        properties.headers = avalanchemq.dom.parseJSON(data.get('headers'))
        const body = {
          payload: data.get('payload'),
          payload_encoding: 'string',
          routing_key: data.get('routing_key'),
          properties
        }
        avalanchemq.http.request('POST', url, { body })
          .then(() => console.log('message published'))
          .catch(e => console.error(e))
      })

      document.querySelector('#deleteExchange').addEventListener('submit', function (evt) {
        evt.preventDefault()
        const url = '/api/exchanges/' + urlEncodedVhost + '/' + urlEncodedExchange
        avalanchemq.http.request('DELETE', url)
          .then(() => { window.location = '/exchanges' })
          .catch(e => console.error(e))
      })
    </script>
  </body>
</html>
