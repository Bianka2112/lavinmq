<!DOCTYPE html>
<html>
  <head>
    <title>Queues | AvalancheMQ</title>
    <style>
      body { font-family: 'Menlo', monospace; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>AvalancheMQ</h1>
      <div id="xhr-error"></div>
      <ul id="menu">
        <li><a href="/">Overview</a></li>
        <li><a href="/queues">Queues</a></li>
      </ul>
      <h2>
        Queues
        <small id="queue-count"></small>
      </h2>
      <table id="queues">
        <thead>
          <tr>
            <th>Name</th>
            <th>VHost</th>
            <th>Durable</th>
            <th>Messages</th>
            <th>Unacked</th>
            <th>Ready</th>
            <th>Consumers</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <script>
      var t = document.getElementById("queues").tBodies[0];
      var sortColumns = ["vhost", "name"];
      updateQueues();
      setInterval(updateQueues, 5000);

      function updateQueues() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/api/queues');
        xhr.onload = function(e) {
          document.getElementById("xhr-error").textContent = "";
          var data = JSON.parse(this.response).sort(function (a, b) {
            for (var i = 0; i < sortColumns.length; i++) {
              if (a[sortColumns[i]] > b[sortColumns[i]]) return 1;
              if (a[sortColumns[i]] < b[sortColumns[i]]) return -1;
            }
            return 0;
          });
          document.getElementById("queue-count").textContent = data.length;

          for (var i = 0; i < data.length; i++) {
            var queue = data[i];
            if (i < t.rows.length) {
              var tr = t.rows[i];
              if (tr.getAttribute("name") === queue.name && tr.getAttribute("vhost") === queue.vhost) {
                // update row
                updateCell(tr, 3, queue.messages);
                updateCell(tr, 4, queue.unacked);
                updateCell(tr, 5, queue.ready);
                updateCell(tr, 6, queue.consumers);
              } else if (i + 1 < t.rows.length && t.rows[i + 1].getAttribute("name") === queue.name && t.rows[i + 1].getAttribute("vhost") === queue.vhost) {
                console.log("next row got our data, deleting this and redoing");
                t.deleteRow(i);
                i--;
              } else {
                // add row because next row doesn't have this queue data
                console.log("next row does not have our data, inserting");
                var tr = t.insertRow(i);
                updateRow(tr, queue);
              }
            } else {
              var tr = t.insertRow(-1);
              updateRow(tr, queue);
            }
          }

          if (data.length < t.rows.length) {
            for (var i = data.length; i < t.rows.length; i++)
              t.deleteRow(i);
          }
        }
        xhr.onerror = function(e) {
          document.getElementById("xhr-error").textContent = "Error fetching data";
        };
        xhr.ontimeout = function(e) {
          document.getElementById("xhr-error").textContent = "Error fetching data";
        };
        xhr.timeout = 5000;
        xhr.send();
      }

      function updateCell(tr, index, value) {
        var text = value.toString();
        var cell = tr.cells[index];
        if (cell.textContent !== text)
          cell.textContent = text;
      }

      function updateRow(tr, queue) {
        tr.setAttribute("name", queue.name);
        tr.setAttribute("vhost", queue.vhost);
        appendTextCell(tr, queue.name);
        appendTextCell(tr, queue.vhost);
        appendTextCell(tr, queue.durable ? "âœ…" : "" );
        appendTextCell(tr, queue.messages);
        appendTextCell(tr, queue.unacked);
        appendTextCell(tr, queue.ready);
        appendTextCell(tr, queue.consumers);
      }

      function appendTextCell(tr, text) {
        var td = tr.insertCell(-1);
        td.appendChild(document.createTextNode(text));
      }
    </script>
  </body>
</html>
