#!/bin/sh
set -eu
[ $# -eq 1 ] || (echo "usage: $(basename $0) pkg_revision"; exit 1)
which dpkg-deb > /dev/null || (echo "dpkg-deb required"; exit 1)
which fakeroot > /dev/null || (echo "fakeroot required"; exit 1)
which help2man > /dev/null || (echo "help2man required"; exit 1)
pkg_version=$(crystal eval 'require "./src/avalanchemq/version"; puts AvalancheMQ::VERSION')
pkg_revision=$1
root=avalanchemq_${pkg_version}-${pkg_revision}_$(dpkg --print-architecture)

shards build --release --production

rm -rf $root
mkdir -p $root/DEBIAN
mkdir -p $root/usr/bin
mkdir -p $root/lib/systemd/system
mkdir -p $root/etc/avalanchemq
mkdir -p $root/usr/share/doc/avalanchemq
mkdir -p $root/usr/share/man/man1
install -s bin/avalanchemq $root/usr/bin
install -s bin/avalanchemqctl $root/usr/bin
cp extras/avalanchemq.service $root/lib/systemd/system
cp extras/config.ini $root/etc/avalanchemq/avalanchemq.ini
cp NOTICE $root/usr/share/doc/avalanchemq/
cp README.md $root/usr/share/doc/avalanchemq/README
cat > $root/usr/share/doc/avalanchemq/copyright << EOF
Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
Upstream-Name: AvalancheMQ
Upstream-Contact: contact@avalanchemq.com
Source: https://github.com/avalanchemq/avalanchemq

Files: *
Copyright: 2018, 84codes AB
License: Apache-2.0
EOF
help2man -Nn "fast and advanced message queue server" bin/avalanchemq > $root/usr/share/man/man1/avalanchemq.1
help2man -Nn "control utility for avalanchemq server" bin/avalanchemqctl > $root/usr/share/man/man1/avalanchemqctl.1
gzip -9 -n $root/usr/share/man/man1/avalanchemq.1
gzip -9 -n $root/usr/share/man/man1/avalanchemqctl.1

cd $root
find . -type f -not -path "./DEBIAN/*" | xargs md5sum > DEBIAN/md5sums
cd - > /dev/null

cat > $root/DEBIAN/conffiles << EOF
/etc/avalanchemq/avalanchemq.ini
EOF

cat > $root/DEBIAN/control << EOF
Package: avalanchemq
Version: $pkg_version-$pkg_revision
Homepage: https://github.com/cloudamqp/avalanchemq
Section: net
Priority: optional
Architecture: $(dpkg --print-architecture)
Depends: openssl (>= 1.0.1), systemd, libc6, adduser
Installed-Size: $(du -ks $root/usr | cut -f 1)
Maintainer: CloudAMQP <contact@cloudamqp.com>
Description: message queue server that implements the AMQP 0-9-1 protocol
 Aims to be very fast, have low RAM requirements,
 handle extreamly long queues, many connections and
 require minimal configuration.

EOF

cat > $root/DEBIAN/postinst << EOF
#!/bin/sh -e
adduser --system --group --quiet --no-create-home --home /nonexistent avalanchemq
install --owner=avalanchemq --group=avalanchemq --mode=750 --directory /var/lib/avalanchemq
deb-systemd-helper enable avalanchemq.service
deb-systemd-invoke start avalanchemq.service
EOF
chmod +x $root/DEBIAN/postinst

cat > $root/DEBIAN/prerm << EOF
#!/bin/sh -e
deb-systemd-invoke stop avalanchemq.service
deb-systemd-helper purge avalanchemq.service
EOF
chmod +x $root/DEBIAN/prerm

fakeroot dpkg-deb --build $root
rm -r $root
